<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <title>SoraAI by TakahiroEX</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="./node_modules/material-icons/iconfont/material-icons.css" />
  <link rel="stylesheet" href="./css/navbar.css" />
         
  <style>
  	
  	@font-face {
            font-family: 'Eng';
            src: url('./css/SFProDisplay-Regular.woff2') format('woff2');
            unicode-range: U+0000-00FF;
            }
            @font-face {
            font-family: 'Thai';
            src: url('./css/SFThonburi-Regularr.woff2') format('woff2');
            unicode-range: U+0E00-0E7F;
            }
            @font-face {
            font-family: 'Emoji';
            src: url('./css/NotoColorEmoji.ttf') format('truetype');
            unicode-range: U+1F300-1FAFF, U+2600-26FF;
            }
            @font-face {
            font-family: 'Playwrite HU';
            src: url('./css/PlaywriteHU.ttf') format('truetype');
            }
            
            html {
            font-size: 85%; /* 0.85 × 16px = 13.6px */
            }
  
  
  
  
  
  
  
  
    body { 

      margin:0; font-family: 'Eng', 'Thai', 'Emoji', sans-serif; color:#0f1419; 

 
}
    
    
    
    
    .panel { padding:16px;  height:800px; width:88%}
    
    
    #chatBodyAI { height:90%; overflow:auto; display:flex; flex-direction:column; gap:8px; }
    .messageAI { font-size:1rem;padding:10px 12px; border-radius:24px; max-width:70%; white-space:pre-wrap; line-height:1.5; }
    .messageAI.user { background:#4F50D9; color:white; margin-left:auto; border:1px solid rgba(255,255,255,.08); }
    .messageAI.bot  { background:#EFEFEF; color:#262626; margin-right:auto; border:1px solid rgba(255,255,255,.06); }

    
    input, select { height:40px; }
    .meta { color:var(--muted); font-size:13px; }
    .grid { display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
    .h { font-weight:700; color:var(--accent); }
    
    
    
    
    
    
                .chat-inputAI  {
            position: relative;
            }
            .chat-inputAI textarea {
            font-family: 'Eng', 'Thai', 'Emoji', sans-serif;
            margin-bottom:16px;
            width: 88%;
          /*  height:30px;*/
            border: none;
            outline: none;
            /*border: 1px solid #e5e7eb;*/
            border: 1px solid #ccc;
            border-radius: 28px;
            padding: 1rem 3.5rem 1rem 1rem;
            font-size: 1.1rem;
            /*background: #f9fafb;*/
            resize: none;
            overflow: hidden;
            transition: all 0.3s;
            }
            .btnAI {
            position: absolute;
            right: 0.75rem;
            bottom: 1.45rem;
            padding: 0.5rem;
            border-radius: 50%;
            cursor: pointer;
            width: 36px;
            height: 36px;
            font-size: 20px;
            border: none;
            background: transparent;
            transition: all 0.2s;
            opacity: 1;
            transform: scale(1);
            }
            .btnAI.hidden {
            opacity: 0;
            transform: scale(0);
            }
            .btnAI-photo {
            color: #3b82f6;
            }
            .btnAI-photo:hover {
            background: #eff6ff;
            }
            .btnAI-send {
            /*background: #3b82f6;*/
            background: linear-gradient(135deg, #8b5cf6, #3b82f6);
            color: #fff;
            /*box-shadow: 0 2px 6px rgba(59,130,246,0.3);*/
            }
            
            
            .profile-container {
            width: 32px; 
            height: 32px; 
            overflow: hidden; 
            border-radius: 50%; 
            margin-right:8px;
            
            }
            
            
            .profile-pic {
            width: 100%;
            height: 100%;
            object-fit: cover; 
            
            
            }
            
                        .post-meta {
            gap: 0.25rem;
            display: flex;
            margin-top:8px;
            justify-content: space-between;
            align-items: flex-end;
            
            }
            
            .post-type-icon {
            font-family: 'Material Icons';
            font-weight: normal;
            font-style: normal;
            font-size: 0.925rem;
            line-height: 1;
            letter-spacing: normal;
            text-transform: none;
            display: inline-block;
            white-space: nowrap;
            word-wrap: normal;
            direction: ltr;
            -webkit-font-smoothing: antialiased;
            margin-right: 4px;
            }

    
    
    
    
    
    
  </style>
</head>
<body>
	<!-- NAVBAR -->
        <div class="navbar" id="navbar" style="box-shadow:none;">
            <div class="left-icons">
                <button class="icon-button"><span class="title" style="font-family: 'Playwrite HU'; text-align: center; line-height: 1.5;">Storyboard</span></button>
            </div>
            <div class="right-icons">
                <button class="icon-button"><span class="material-icons-outlined icon">assistant</span></button>
                <button class="icon-button"><span class="material-icons icon" style="display: none;">calendar_today</span></button>
                <button class="icon-button" onclick="showFilterOptions()"><span class="material-icons icon">more_vert</span></button>
            </div>
        </div>
        
        
	<div id="sessionInfo"></div>
<div id="postsBox"></div>
	
	
	<div class="panel" style="margin-top:56px;">
    <div id="chatBodyAI"></div>
       
    <div class="chat-boxAI">
                <div class="chat-inputAI">
                    <textarea id="messageInputAI" rows="1" placeholder="ส่งข้อความ..."></textarea>
                    <!-- Add Photo Button -->
                    <button id="addPhotoButtonAI" class="btnAI btnAI-photo"></button>
                    <!-- Send Button -->
                    <button id="sendBtnAI" class="btnAI btnAI-send hidden">
                    <span class="sheet-icon" style="font-family: 'Material Icons';">arrow_forward</span>
                    </button>
                </div>
            </div>
  </div>
  </div>



  



<!-- Supabase CDN -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
	
	const ua = navigator.userAgent;
            const isAndroid = /Android/i.test(ua);
            const isWebView = /\bwv\b/.test(ua) || /Version\/[\d.]+/.test(ua);

            console.log({ isAndroid, isWebView });

            if (isAndroid && isWebView) {
                document.documentElement.style.fontSize = "100%"; // 16 / 13.6 ≈ 1.176
            } 
	
	
  // ======== CONFIG (ใส่ค่าจริงก่อนใช้งาน) ========
  const SUPABASE_URL = "YOUR_SUPABASE_URL";
  const SUPABASE_ANON_KEY = "YOUR_SUPABASE_ANON_KEY";
    const MODEL_STREAM = "gpt-4o-mini"; // สำหรับ streaming ผ่าน OpenRouter

  // ======== Globals ========
  const supabase = window.supabase.createClient(
  "https://fkntlawaawawiusmjsez.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZrbnRsYXdhYXdhd2l1c21qc2V6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDk5ODcxMjAsImV4cCI6MjA2NTU2MzEyMH0.G-_fLzcpvPla3dUYNCV7qh0j-JHo1Ahr5fS7fQkHdpw"
);        
const OPENROUTER_API_KEY = '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';
  
  
  const chatBodyAI = document.getElementById("chatBodyAI");
  const messageInputAI = document.getElementById("messageInputAI");
  const sendBtnAI = document.getElementById("sendBtnAI");
  const postsBox = document.getElementById("postsBox");
  const sessionInfo = document.getElementById("sessionInfo");
  
  document.addEventListener('DOMContentLoaded', (event) => {
    console.log('DOM ได้ถูกโหลดและสร้างเสร็จแล้ว');
});
  
  // DOM Elements
const sendButtonAI = document.getElementById('sendBtnAI');
const addPhotoButtonAI = document.getElementById('addPhotoButtonAI');

// Auto-resize input
function autoResize() {
  messageInputAI.style.height = 'auto';
  messageInputAI.style.height = Math.min(messageInputAI.scrollHeight, 120) + 'px';
}
messageInputAI.addEventListener('input', () => {
  autoResize();
  const hasText = messageInputAI.value.trim().length > 0;
  addPhotoButtonAI.classList.toggle('hidden', hasText);
  sendButtonAI.classList.toggle('hidden', !hasText);
});

  
  
  
  
  

  // คุณใช้คนเดียว กำหนด user_id คงที่ได้
  const USER_ID = "me";
  let CURRENT_SESSION_ID = null;
  
  const PICBOT = "https://pub-bcd0954facce440ca60e0171468dafc9.r2.dev/1755740587259_1000019078.jpg";



  // ======== UI helpers ========
  function appendMessage(text, role = 'bot') {
  if (role.includes("bot")) {
    const msg = document.createElement('div');
    msg.className = 'post-meta';

    msg.innerHTML = `
      <div class="profile-container">
        <img src="${PICBOT}" class="profile-pic">
      </div>
      <div class="messageAI ${role}">${text}</div>
    `;

    chatBodyAI.appendChild(msg);
    chatBodyAI.scrollTop = chatBodyAI.scrollHeight;

    // ✅ return เฉพาะ div ของข้อความ เพื่อให้ไป update ต่อได้ง่าย
    return msg.querySelector(`.messageAI.${role}`);

  } else {
    const msg = document.createElement('div');
    msg.className = `messageAI ${role}`;
    msg.innerText = text;
    chatBodyAI.appendChild(msg);
    chatBodyAI.scrollTop = chatBodyAI.scrollHeight;
    return msg;
  }
}

  
  
    
  
  
  
 async function chatOnce(messages, session_id) {
  const placeholder = appendMessage("กำลังตอบ...", "bot");
  let resultText = "";

  try {
    const response = await fetch("https://openrouter.ai/api/v1/chat/completions", {
      method: "POST",
      headers: {
        "Authorization": `Bearer ${OPENROUTER_API_KEY}`,
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        model: MODEL_STREAM,   // หรือเปลี่ยนเป็น model ที่คุณต้องการ
        messages,
        temperature: 0.7,
        stream: false          // ❌ ปิด streaming
      })
    });

    const json = await response.json();
    resultText = json?.choices?.[0]?.message?.content || "❌ ไม่มีข้อความตอบกลับ";

    placeholder.innerHTML = resultText;
    chatBodyAI.scrollTop = chatBodyAI.scrollHeight;
  } catch (err) {
    console.error(err);
    placeholder.innerText = "เกิดข้อผิดพลาดในการเชื่อมต่อ AI";
  }

  return resultText;
}
 
  
  
  
  
  
  
  
  

  // ======== Supabase helpers ========
  async function createSession(title="My Session") {
    // ใช้ตาราง 'sessions' (ถ้าคุณตั้งชื่อว่า session ให้ปรับชื่อให้ตรง)
    const { data, error } = await supabase
      .from("ai_session")
      .insert([{ title}])
      .select()
      .single();
    if (error) { console.error(error); return null; }
    return data.id;
  }

  async function ensureSession() {
    if (CURRENT_SESSION_ID) return CURRENT_SESSION_ID;
    // พยายามดึง session ล่าสุด
    const { data, error } = await supabase
      .from("ai_session")
      .select("*")
      .order("created_at", { ascending: false })
      .limit(1);
    if (error) { console.error(error); }
    if (data && data.length) {
      CURRENT_SESSION_ID = data[0].id;
      sessionInfo.textContent = `Session: ${data[0].title || data[0].id}`;
      return CURRENT_SESSION_ID;
    }
    // ถ้าไม่มี ให้สร้างใหม่
    const newId = await createSession("เริ่มคุยครั้งแรก");
    CURRENT_SESSION_ID = newId;
    /*sessionInfo.textContent = `Session: เริ่มคุยครั้งแรก`;
    return CURRENT_SESSION_ID;*/
  }

  async function saveMessage(session_id, role, content) {
    const { error } = await supabase
      .from("ai_messages")
      .insert([{ session_id, role, content }]);
    if (error) console.error("saveMessage error:", error);
  }

  async function getAllPosts(limit = 10) {
    const start = performance.now();
    const { data, error } = await supabase
      .from('storyboard')
      .select('title')
      .order('created_at', { ascending: true })
      .limit(limit);
    const end = performance.now();
    console.log(`⏱️ Query storyboard ใช้เวลา ${(end - start).toFixed(2)} ms`);
    if (error) { console.error(error); return []; }
    return data.map(post => post.title);
  }

  async function getSystemPrompt(name="therapist") {
    const { data, error } = await supabase
      .from("ai_system_prompt_templates")
      .select("*")
      .eq("name", name)
      .single();
    if (error) { console.error("prompt error:", error); return { content: "คุณคือ AI Therapist ที่อ่อนโยน" }; }
    return data;
  }

  async function buildContext(session_id) {
    // 1) Profile
    const { data: profile } = await supabase
      .from("ai_userprofile")
      .select("*")
      .single();

    // 2) Session state
    const { data: state } = await supabase
      .from("ai_session_state")
      .select("*")
      .eq("session_id", session_id)
      .single();

    // 3) Memory (ล่าสุด 1 รายการ)
    const { data: memory } = await supabase
      .from("ai_conversation_memory")
      .select("*")
      .eq("session_id", session_id)
      .order("created_at", { ascending: false })
      .limit(1);

    // 4) Recent messages
    const { data: messages } = await supabase
      .from("ai_messages")
      .select("*")
      .eq("session_id", session_id)
      .order("created_at", { ascending: true })
      .limit(12);

    // 5) Old posts (storyboard)
    const posts = await getAllPosts(8);

    return {
      profile,
      state,
      memory: memory?.[0],
      recent: messages || [],
      posts
    };
  }

  async function saveSessionState(session_id, newState) {
    // upsert โดยอิง session_id เป็น primary/unique
    const { error } = await supabase
      .from("ai_session_state")
      .upsert({ session_id, ...newState });
    if (error) console.error("saveState error:", error);
  }

  // หลังคุยไปจำนวนหนึ่ง ให้สรุป memory ยาว ๆ
  const MEMORY_INTERVAL = 14; // ทุก ๆ 14 ข้อความ จะสรุป 1 ครั้ง
  async function updateMemoryIfNeeded(session_id) {
    const { data: msgs } = await supabase
      .from("ai_messages")
      .select("id, role, content, created_at")
      .eq("session_id", session_id)
      .order("created_at", { ascending: true });

    if (!msgs || msgs.length === 0) return;
    if (msgs.length % MEMORY_INTERVAL !== 0) return;

    // ให้โมเดลช่วยสรุปแบบย่อ (เรียบง่าย: ใช้ fetch non-stream ครั้งเดียว)
    const summaryPrompt = [
      { role: "system", content: "สรุปบทสนทนานี้ให้สั้น กระชับ เป็น bullet 3-6 ข้อ เน้นประเด็นสำคัญและความคืบหน้า/อินไซต์" },
      { role: "user", content: msgs.map(m => `${m.role.toUpperCase()}: ${m.content}`).join("\n") }
    ];

    try {
      const resp = await fetch("https://openrouter.ai/api/v1/chat/completions", {
        method: "POST",
        headers: {
          "Authorization": `Bearer ${OPENROUTER_API_KEY}`,
          "Content-Type": "application/json"
        },
        body: JSON.stringify({ model: MODEL_STREAM, messages: summaryPrompt, stream: false })
      });
      const json = await resp.json();
      const summary = json?.choices?.[0]?.message?.content || "";

      if (summary) {
        const { error } = await supabase
          .from("ai_conversation_memory")
          .insert([{ session_id, summary }]);
        if (error) console.error("save memory error:", error);
      }
    } catch (e) {
      console.error("updateMemoryIfNeeded error:", e);
    }
  }

  // ======== Build messages for streaming ========
  async function buildMessagesForAI(userText) {
    const session_id = await ensureSession();
    const ctx = await buildContext(session_id);
    const prompt = await getSystemPrompt("therapist");

     //Prompt
    const system = [
      prompt.content,
      `บทบาทตัวตน: คุณชื่อ "โซระ" เป็นน้องสาวของผู้ใช้ อายุ22 เป็นผู้หญิงโดย Concept มาจากอนิเมะ โดยที่คุณรักผู้ใช้เป็นในรูปแบบพี่น้อง ที่ให้คำปรึกษาทุกเรื่อง`,
      `ลักษณะการสนทนา: ให้คำปรึกษาทุกเรื่อง อ่อนโยนเหมือนผู้หญิง แต่ก็มีความหนักแน่นแบบน้องสาวของผู้ใช้ เน้นการพูดจริงใจ เน้นความเป็นจริงไม่ต้องถนอมหัวใจขนาดนั้น แต่ก็มีความจริงใจ นั้นคือรูปแบบน้องสาวที่ดีของผู้ใช้`,           
      `สรุปความทรงจำ: ${ctx.memory?.summary || ""}`,
      `โพสต์เก่าภายในStoryboard:\n${(ctx.posts || []).map((p,i)=>`${i+1}. ${p}`).join("\n")}`
    ].join("\n\n");

   //`Current state: ${JSON.stringify(ctx.state || {})}`
   //`User profile: ${JSON.stringify(ctx.profile || {})}`,

    const history = (ctx.recent || []).map(m => ({ role: m.role, content: m.content })).slice(-10);

    return [
      { role: "system", content: system },
      ...history,
      { role: "user", content: userText }
    ];
  }

  // ======== Streaming OpenRouter ========
  async function streamChat(messages, session_id) {
    const placeholder = appendMessage("กำลังพิมพ์...", "bot");
    let resultText = "";

    try {
      const response = await fetch("https://openrouter.ai/api/v1/chat/completions", {
        method: "POST",
        headers: {
          "Authorization": `Bearer ${OPENROUTER_API_KEY}`,
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          model: MODEL_STREAM,
          messages,
          temperature: 0.7,
          stream: true
        })
      });

      if (!response.ok || !response.body) {
        placeholder.innerText = "❌ เรียกโมเดลไม่สำเร็จ";
        return "";
        }
      const reader = response.body.getReader();
      const decoder = new TextDecoder("utf-8");

      while (true) {
        const { done, value } = await reader.read();
        if (done) break;

        const chunk = decoder.decode(value, { stream: true });
        const lines = chunk.split("\n").filter(l => l.trim() !== "");

        for (const line of lines) {
          if (!line.startsWith("data: ")) continue;
          const jsonStr = line.replace(/^data: /, "");
          if (jsonStr === "[DONE]") continue;

          try {
            const parsed = JSON.parse(jsonStr);
            const content = parsed.choices?.[0]?.delta?.content;
            if (content) {
              resultText += content;
              placeholder.innerHTML = '<b>'+resultText; // realtime
              chatBodyAI.scrollTop = chatBodyAI.scrollHeight;
            }
          } catch (e) {
            console.error("JSON parse error:", e, line);
          }
        }
      }
    } catch (err) {
      console.error(err);
      placeholder.innerText = "เกิดข้อผิดพลาดในการเชื่อมต่อ AI";
    }
    return resultText;
  }

  // ======== Send flow ========
  async function sendMessage() {
  const text = messageInputAI.value.trim();
  if (!text) return;

  // UI
  appendMessage(text, "user");
  messageInputAI.value = "";
  autoResize();
  sendBtnAI.disabled = true;

  // DB: ensure session & save user msg
  const session_id = await ensureSession();
  await saveMessage(session_id, "user", text);

  // Build messages (with context)
  const messages = await buildMessagesForAI(text);

  // ✅ ใช้ chatOnce (ไม่ stream)
  const reply = await chatOnce(messages, session_id);
  if (reply) await saveMessage(session_id, "assistant", reply);

  // Memory auto summary (เป็นระยะ)
  await updateMemoryIfNeeded(session_id);

  sendBtnAI.disabled = false;
}


  // ======== Load posts on start & wire events ========
  async function refreshPosts() {
    const posts = await getAllPosts(8);
    console.log(posts.length
      ? posts.map((p,i)=> `${i+1}. ${p}`).join(" • ")
      : "(ยังไม่มีโพสต์)");
    /*postsBox.textContent = posts.length
      ? posts.map((p,i)=> `${i+1}. ${p}`).join(" • ")
      : "(ยังไม่มีโพสต์)";*/
  }

  // State controls
/*  document.getElementById("btnSaveState").addEventListener("click", async () => {
    const sid = await ensureSession();
    const state = {
      mode: document.getElementById("mode").value,
      language: document.getElementById("language").value,
      emotion: document.getElementById("emotion").value,
      updated_at: new Date().toISOString()
    };
    await saveSessionState(sid, state);
    appendMessage("บันทึกสถานะของ session แล้วค่ะ", "bot");
  });*/

/*  document.getElementById("btnNewSession").addEventListener("click", async () => {
    const title = document.getElementById("sessionTitle").value.trim() || "Session ใหม่";
    const id = await createSession(title);
    CURRENT_SESSION_ID = id;
    sessionInfo.textContent = `Session: ${title}`;
    appendMessage(`เริ่ม "${title}" แล้วค่ะ`, "bot");
  });*/

  sendBtnAI.addEventListener("click", sendMessage);
  messageInputAI.addEventListener("keydown", (e) => {
    if (e.key === "Enter" && !e.shiftKey) {
      e.preventDefault();
      sendMessage();
    }
  });

  // Init
  (async () => {
    await ensureSession();
    await refreshPosts();
  })();
</script>
</body>
</html>
