<!DOCTYPE html>
<html lang="th">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Tiptap Editor Mobile + Table</title>
        <link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" rel="stylesheet" />
        <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@1.35.6/dist/umd/supabase.min.js"></script>

        <link
            rel="stylesheet"
            href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css"
            integrity="sha512-Evv84Mr4kqVGRNSgIGL/F/aIDqQb7xQ2vcrdIwxfjThSH8CSR7PBEakCr51Ck+w+/U6swU2Im1vVX0SVk9ABhg=="
            crossorigin="anonymous"
            referrerpolicy="no-referrer"
        />
        <style>
            /* Global Resets and Base Styles */
            html,
            body {
                margin: 0;
                padding: 0;
                height: 100%;
                font-family: sans-serif;
                background-color: #f8f8f8;
                overflow: hidden; /* Prevent scrolling of the entire page */
            }

            /* Main Editor Wrapper - Ensures it fills the screen and arranges children vertically */
            #editor-wrapper {
                height: 100vh; /* Make wrapper take full viewport height */
                display: flex;
                flex-direction: column;
                background-color: #fff;
                background-position: center center; /* ‡∏à‡∏±‡∏î‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏Å‡∏∂‡πà‡∏á‡∏Å‡∏•‡∏≤‡∏á */
                background-repeat: no-repeat; /* ‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏£‡∏π‡∏õ‡∏ã‡πâ‡∏≥ */
                background-size: cover; /* ‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏•‡∏∏‡∏°‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î */
                transition: background-color 0.2s, background-image 0.2s; /* ‡πÄ‡∏û‡∏¥‡πà‡∏° transition ‡πÉ‡∏´‡πâ‡∏î‡∏π smooth */
            }

            /* === NEW: Navbar Styles === */
            .navbar {
                display: flex;
                align-items: center;
                justify-content: space-between; /* Puts items at ends and center */
                padding: 16px 16px; /* Adjust padding as needed */

                background-color: rgba(255, 255, 255, 0); /* ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏™‡∏µ‡∏Ç‡∏≤‡∏ß‡πÇ‡∏õ‡∏£‡πà‡∏á‡πÉ‡∏™ 60% */
                /*border-bottom: 1px solid #eee;  Subtle bottom border */
                /*box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);*/ /* Optional: subtle shadow */
                flex-shrink: 0; /* Ensures navbar doesn't shrink */
                margin-bottom: 2px;
            }

            .navbar-button {
                background: none;
                border: none;
                font-size: 24px; /* Adjust icon size */
                cursor: pointer;
                padding: 0 5px; /* Adjust spacing around icon */
                color: #333; /* Icon color */
                display: flex;
                align-items: center;
                justify-content: center;
            }

            .navbar-title {
                font-size: 18px; /* Title font size */
                font-weight: bold;
                color: #333;
                flex-grow: 1; /* Allows title to take available space */
                text-align: center; /* Centers the title */
            }
            /* === END NEW: Navbar Styles === */

            /* Title Field - Stays at the top, fixed height */
            #note-title {
                padding: 10px 16px;
                margin: 0; /* Important: Remove any default margins */
                font-weight: bold;
                font-size: 22px;
                border: none;
                outline: none;
                flex-shrink: 0; /* Prevent title from shrinking when space is limited */
            }

            /* Tiptap Editor Container - This div wraps the actual ProseMirror content */
            #editor {
                flex-grow: 1; /* Allow editor to take all *remaining* available space */
                overflow-y: auto; /* Enable vertical scrolling if content overflows */

                min-height: 150px; /* ‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏õ‡∏£‡∏±‡∏ö‡∏Ñ‡πà‡∏≤‡∏ô‡∏µ‡πâ‡πÑ‡∏î‡πâ‡∏ï‡∏≤‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏° ‡πÄ‡∏ä‡πà‡∏ô 100px, 200px */
                box-sizing: border-box; /* ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ padding ‡πÅ‡∏•‡∏∞ border ‡πÑ‡∏°‡πà‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏Ç‡∏ô‡∏≤‡∏î‡πÄ‡∏Å‡∏¥‡∏ô */
                padding: 0; /* ‡∏•‡πâ‡∏≤‡∏á padding ‡∏Ç‡∏≠‡∏á #editor ‡∏≠‡∏≠‡∏Å ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ ProseMirror ‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡πÄ‡∏≠‡∏á */
            }

            /* ProseMirror (The actual editable content area generated by Tiptap) */
            .ProseMirror {
                padding: 16px; /* Padding ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏î‡πâ‡∏≤‡∏ô‡πÉ‡∏ô‡∏Ç‡∏≠‡∏á Editor */
                outline: none;

                min-height: 100%;
                height: auto;

                line-height: 1.5; /*‡∏õ‡∏£‡∏±‡∏ö‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î Editor*/
                box-sizing: border-box;
                -webkit-overflow-scrolling: touch;
                position: relative;

                /* ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£ Reset Margin/Padding ‡∏Ç‡∏≠‡∏á Paragraph/Headings ‡∏†‡∏≤‡∏¢‡πÉ‡∏ô ProseMirror */
                /* ‡∏ô‡∏µ‡πà‡∏Ñ‡∏∑‡∏≠‡∏à‡∏∏‡∏î‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏´‡∏£‡∏∑‡∏≠‡∏™‡πà‡∏ß‡∏ô‡∏ï‡πâ‡∏ô‡∏Ç‡∏≠‡∏á Editor ‡∏î‡∏π‡πÇ‡∏•‡πà‡∏á‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ */
                & > p:first-child {
                    margin-top: 0;
                }
                & > p {
                    margin-top: 0;
                    margin-bottom: 0em; /*0.5*/
                }

                /* ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Heading tags */
                & > h1,
                & > h2,
                & > h3,
                & > h4,
                & > h5,
                & > h6 {
                    margin-top: 0.5em;
                    margin-bottom: 0.5em;
                }
            }

            .ProseMirror .large-paragraph {
                margin-top: 1em; /* ‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á‡∏¢‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤‡∏õ‡∏Å‡∏ï‡∏¥ */
                margin-bottom: 1em; /* ‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á‡∏¢‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤‡∏õ‡∏Å‡∏ï‡∏¥ */
                line-height: 1.5;
                /* ‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏≠‡∏∑‡πà‡∏ô ‡πÜ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏´‡πá‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏ï‡∏Å‡∏ï‡πà‡∏≤‡∏á‡πÑ‡∏î‡πâ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà */
            }

            /* Placeholder Text - Positioned absolutely to not affect layout flow */
            .ProseMirror p.is-editor-empty:first-child::before {
                content: attr(data-placeholder);
                color: #adb5bd;
                pointer-events: none;
                position: absolute;
                top: 16px;
                left: 16px;
            }

            .ProseMirror img {
                max-width: 100%;
                height: auto;
                display: block;
                margin: 8px 0;
            }
            /*
    .ProseMirror blockquote {
      border-left: 4px solid #ccc;
      margin: 8px 0;
      padding-left: 12px;
      color: #555;
      font-style: italic;
      background: #f9f9f9;
    }
*/
            .ProseMirror blockquote {
                border-left: 4px solid #3e7eff;
                background: #eef4ff;
                padding: 12px 16px;
                margin: 16px 0;
                border-radius: 66px;
                font-style: italic;
                box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
                color: #333;
            }

            /* Basic editor styles */
            .ProseMirror > :first-child {
                margin-top: 0;
            }

            /* Details */
            .ProseMirror .details {
                display: flex;
                gap: 0.25rem;
                margin: 1.5rem 0;
                border: 1px solid var(--gray-3);
                border-radius: 0.5rem;
                padding: 0.5rem;
            }

            .ProseMirror .details summary {
                font-weight: 700;
            }

            .ProseMirror .details > button {
                align-items: center;
                background: transparent;
                border-radius: 4px;
                display: flex;
                font-size: 0.625rem;
                height: 1.25rem;
                justify-content: center;
                line-height: 1;
                margin-top: 0.1rem;
                padding: 0;
                width: 1.25rem;
            }

            .ProseMirror .details > button:hover {
                background-color: var(--gray-3);
            }

            .ProseMirror .details > button::before {
                content: "\25B6";
            }

            .ProseMirror .details.is-open > button::before {
                transform: rotate(90deg);
            }

            .ProseMirror .details > div {
                display: flex;
                flex-direction: column;
                gap: 1rem;
                width: 100%;
            }

            .ProseMirror .details > div > [data-type="detailsContent"] > :last-child {
                margin-bottom: 0.5rem;
            }

            .ProseMirror .details .details {
                margin: 0.5rem 0;
            }

            .ProseMirror hr {
                border: none;
                border-top: 1px solid #ccc;
                margin: 16px 0;
            }

            .mention {
                color: #1e88e5;
                background-color: #e3f2fd;
                padding: 2px 6px;
                border-radius: 4px;
            }

            .mention-list {
                font-size: 14px;
                max-height: 200px;
                overflow-y: auto;
            }

            .mention-option:hover {
                background-color: #f0f0f0;
            }

            .ProseMirror [data-type="taskList"] li {
                display: flex;
                align-items: center; /* <<< ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç */
                gap: 8px;
                margin: 1px 0; /*‡∏õ‡∏£‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡πà‡∏≤‡∏á tasklist*/
            }

            .ProseMirror [data-type="taskList"] li > label {
                margin: 0;
                padding: 0;
                flex-shrink: 0;
            }

            .ProseMirror [data-type="taskList"] li > div {
                flex: 1;
            }

            .ProseMirror [data-type="taskList"] input[type="checkbox"] {
                margin: 0;
                transform: translateY(1px); /* ‡∏õ‡∏£‡∏±‡∏ö‡πÉ‡∏´‡πâ checkbox ‡∏Ç‡∏∂‡πâ‡∏ô‡∏•‡∏á‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î */
            }
            .ProseMirror [data-type="taskList"] p {
                margin: 0;
                line-height: 1.4;
            }

            .color-button {
                position: relative;
                background-color: #f0f0f0;
                border: none;
                border-radius: 999px;
                width: 36px;
                height: 36px;
                font-size: 16px;
                display: flex;
                align-items: center;
                justify-content: center;
                cursor: pointer;
                overflow: hidden;
                flex-shrink: 0;
                transition: background-color 0.2s;
            }

            .color-button:hover {
                background-color: #ddd;
            }

            /* Toolbar - Fixed at the bottom */
            .toolbar {
                display: flex;
                flex-wrap: nowrap;
                overflow-x: auto;
                padding: 6px 10px;
                background-color: #ffffff;
                border-top: 1px solid #ccc;
                box-shadow: 0 -1px 4px rgba(0, 0, 0, 0.05);
                gap: 8px;
                justify-content: flex-start;
                flex-shrink: 0; /* Prevent toolbar from shrinking */

                /* === ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ === */
                position: fixed; /* ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô fixed */
                bottom: 0; /* ‡πÉ‡∏´‡πâ‡∏≠‡∏¢‡∏π‡πà‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡∏™‡∏∏‡∏î */
                left: 0;
                right: 0;
                z-index: 99; /* ‡∏Å‡∏≥‡∏´‡∏ô‡∏î z-index ‡πÉ‡∏´‡πâ‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤ bottom-sheet-overlay */
                /* =================== */
            }

            .toolbar button {
                /*background-color: #f0f0f0;*/
                background-color: rgba(255, 255, 255, 0.6);
                border: none;
                padding: 8px;
                border-radius: 999px;
                font-size: 18px;
                width: 32px;
                height: 32px;
                display: flex;
                align-items: center;
                justify-content: center;
                cursor: pointer;
                flex-shrink: 0;
                /*transition: background-color 0.2s;*/
            }

            .toolbar button:hover {
                background-color: rgba(255, 255, 255, 0.6);
                /*background-color: #ddd;*/
            }

            .toolbar button.is-active {
                background-color: #a3d0ff;
                font-weight: bold;
            }

            /* Table styles */
            table {
                border-collapse: collapse;
                width: 100%;
            }

            td,
            th {
                border: 1px solid #ccc;
                padding: 8px;
            }

            .bottom-sheet-overlay {
                position: fixed;
                inset: 0; /* shorthand for top:0; right:0; bottom:0; left:0 */
                background: rgba(0, 0, 0, 0.4);
                display: flex;
                align-items: flex-end;
                justify-content: center;
                z-index: 9999; /* ‡∏™‡∏π‡∏á‡∏Å‡∏ß‡πà‡∏≤ Toolbar */
            }

            .bottom-sheet {
                background: #fff;
                width: 100%;
                max-height: 80vh;
                border-top-left-radius: 16px;
                border-top-right-radius: 16px;
                padding: 16px;
                box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.2);
                overflow-y: auto;
            }

            .bottom-sheet-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 12px;
            }

            .bottom-sheet-close-btn {
                background: none;
                border: none;
                font-size: 24px;
                cursor: pointer;
            }

            .option-grid {
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(40px, 1fr));
                gap: 8px;
            }

            .color-option {
                width: 40px;
                height: 40px;
                border-radius: 8px;
                border: 2px solid #ccc;
                cursor: pointer;
            }

            .image-option {
            	margin-top: 8px;
                width: 40px;
                height: 40px;
                border-radius: 8px;
                border: 2px solid #ccc;
                cursor: pointer;
                overflow: hidden; /* ‡∏ã‡πà‡∏≠‡∏ô‡∏™‡πà‡∏ß‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô‡∏Ç‡∏≠‡∏á‡∏£‡∏π‡∏õ */
                display: flex;
                align-items: center;
                justify-content: center;
                background-color: #f0f0f0; /* ‡∏™‡∏µ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏£‡∏π‡∏õ‡πÑ‡∏°‡πà‡πÇ‡∏´‡∏•‡∏î */
            }

            .image-option img {
                max-width: 100%;
                max-height: 100%;
                object-fit: cover; /* ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏•‡∏∏‡∏°‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà */
            }

            .upload-option,
            .download-icon {
                background-color: #e0e0e0; /* ‡∏™‡∏µ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î/‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î */
            }

            .upload-option:hover,
            .image-option:hover {
                border-color: #4285f4; /* ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏µ‡∏Ç‡∏≠‡∏ö‡πÄ‡∏°‡∏∑‡πà‡∏≠ hover */
            }

            .transparent-input {
                background-color: rgba(255, 255, 255, 0); /* ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏™‡∏µ‡∏Ç‡∏≤‡∏ß‡πÇ‡∏õ‡∏£‡πà‡∏á‡πÉ‡∏™ 60% */
                border: 1px solid #ccc; /* ‡∏≠‡∏≤‡∏à‡∏à‡∏∞‡πÄ‡∏û‡∏¥‡πà‡∏° border ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏¢‡∏±‡∏á‡πÄ‡∏´‡πá‡∏ô‡∏Ç‡∏≠‡∏ö‡πÄ‡∏Ç‡∏ï‡∏Ç‡∏≠‡∏á input */
                padding: 8px;
                transition: opacity 0.3s ease-in-out; /* ‡πÄ‡∏û‡∏¥‡πà‡∏° transition ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏Å‡∏¥‡∏î animation ‡∏ï‡∏≠‡∏ô‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡πÇ‡∏õ‡∏£‡πà‡∏á‡πÉ‡∏™ */
            }

            .transparent-input:focus {
                background-color: rgba(255, 255, 255, 0); /* ‡∏™‡∏µ‡∏Ç‡∏≤‡∏ß‡πÇ‡∏õ‡∏£‡πà‡∏á‡πÉ‡∏™ 50% */
                outline: none; /* ‡∏•‡∏ö‡πÄ‡∏™‡πâ‡∏ô‡∏Ç‡∏≠‡∏ö‡∏™‡∏µ‡∏ü‡πâ‡∏≤‡πÜ ‡∏ó‡∏µ‡πà‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡∏∂‡πâ‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÇ‡∏ü‡∏Å‡∏±‡∏™ */
            }
            
            /* === New Styles for Settings Bottom Sheet === */
            #settingsBottomSheetOverlay {
                z-index: 100; /* ‡πÉ‡∏´‡πâ‡∏™‡∏π‡∏á‡∏Å‡∏ß‡πà‡∏≤ bottomSheetOverlay ‡∏≠‡∏∑‡πà‡∏ô‡πÜ */
            }

            #settingsBottomSheet {
                max-width: 600px; /* ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏õ‡∏£‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î‡πÑ‡∏î‡πâ‡∏ï‡∏≤‡∏°‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ */
                padding: 24px;
                
            }

            .chip-section h3, .title-section h3 {
                margin-top: 0;
                margin-bottom: 12px;
                font-size: 1.1em;
                color: #555;
            }

            .chip-grid {
                display: flex;
                flex-direction: column; /* ‡∏à‡∏±‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ */
                gap: 8px; /* ‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ä‡∏¥‡∏õ */
            }

            .chip {
                display: flex;
                align-items: center;
                width:70px;
                padding: 10px 15px;
                background-color: #2A2A2A; /* ‡∏™‡∏µ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏ä‡∏¥‡∏õ */
                
                font-weight: bold;
                border-radius: 80px; /* ‡∏°‡∏∏‡∏°‡πÇ‡∏Ñ‡πâ‡∏á‡∏°‡∏ô */
                font-size: 0.8em;
                color: white;
                
                transition: background-color 0.2s;
                border: 1px solid #eee; /* ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏≠‡∏ö‡∏ö‡∏≤‡∏á‡πÜ */
            }


            .chip i { /* ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô Font Awesome ‡∏†‡∏≤‡∏¢‡πÉ‡∏ô‡∏ä‡∏¥‡∏õ */
                margin-right: 8px; /* ‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡∏Å‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° */
                color: white;
                font-size: 1.2em;
                width: 20px; /* ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡∏à‡∏±‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô */
                text-align: center;
            }

            

            .title-section {
                margin-top: 5px;
                padding-top: 5px;
               
                border-top: 1px solid #eee; /* ‡πÄ‡∏™‡πâ‡∏ô‡πÅ‡∏ö‡πà‡∏á‡∏™‡πà‡∏ß‡∏ô */
            }
            #settingsNoteTitle {
                width: 100%;
                
                
                font-size: 1.25em;
                box-sizing: border-box; /* ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ padding ‡πÑ‡∏°‡πà‡∏ó‡∏≥‡πÉ‡∏´‡πâ input ‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡πÄ‡∏Å‡∏¥‡∏ô */
            }

            /* END New Styles */
            
            .setting-button {
            background-color: rgba(255, 255, 255, 0); 
            color: #2A2A2A;
            display: flex;
                align-items: center;
                
                padding: 10px 15px;
                
                
                font-weight: bold;
                border-radius: 80px; /* ‡∏°‡∏∏‡∏°‡πÇ‡∏Ñ‡πâ‡∏á‡∏°‡∏ô */
                font-size: 1.15em;
                
                
                
                border: 0px solid #eee; /* ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏≠‡∏ö‡∏ö‡∏≤‡∏á‡πÜ */
}

.setting-button:active {
background-color: #d1e9ff;
}

            .setting-button i { /* ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô Font Awesome ‡∏†‡∏≤‡∏¢‡πÉ‡∏ô‡∏ä‡∏¥‡∏õ */
                margin-right: 12px; /* ‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡∏Å‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° */
                color: #2A2A2A;
                
                width: 20px; /* ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡∏à‡∏±‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô */
                text-align: center;
            }         
            
        </style>

    </head>
    <body>
        <div id="editor-wrapper">
            <div class="navbar">
                <button class="navbar-button" id="backButton">
                    <i class="fa-solid fa-arrow-left"></i>
                </button>
                <div class="navbar-title"></div>
                <button class="navbar-button" id="settingsButton">
                    <i class="fa-solid fa-gear"></i>
                </button>
            </div>
            <input id="note-title" type="text" placeholder=". . ." class="transparent-input" />
            <div id="editor"></div>

            <div class="toolbar">
                <button id="toggleLargeParagraphButton">
                    <i class="fa-solid fa-paragraph"></i>
                </button>
                <button id="insertTimeButton" class="toolbar-button" title="‡πÅ‡∏ó‡∏£‡∏Å‡πÄ‡∏ß‡∏•‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô">
                    <i class="fas fa-clock"></i>
                </button>
                <button id="taskListButton">
                    <i class="fa-solid fa-square-check"></i>
                </button>
                <button id="imageButton">
                    <i class="fa-solid fa-image"></i>
                </button>
                <!--       <button id="backgroundButton1"> -->
                <!--      <i class="fa-solid fa-brush"></i> -->
                <!--         </button> -->
                <button id="detailsButton">
                    <i class="fa-solid fa-info"></i>
                </button>
                <button class="toolbar-button" id="boldButton" title="Bold">
                    <i class="fa-solid fa-bold"></i>
                </button>
                <button id="italicButton">
                    <i class="fa-solid fa-italic"></i>
                </button>
                <button id="strikeButton">
                    <i class="fa-solid fa-strikethrough"></i>
                </button>
                <button id="codeTextButton">{ }</button>
                <button id="h1Button">
                    <i class="fa-solid fa-heading"></i>
                </button>
                <button id="h2Button">
                    <i class="fa-solid fa-heading"></i>
                </button>
                <button id="bulletListButton">
                    <i class="fa-solid fa-list-ul"></i>
                </button>
                <button id="orderedListButton">
                    <i class="fa-solid fa-list-ol"></i>
                </button>
                <button id="codeBlockButton">[ ]</button>
                <button id="blockquoteButton">
                    <i class="fa-solid fa-quote-left"></i>
                </button>
                <button id="hrButton">
                    <i class="fa-solid fa-arrows-left-right"></i>
                </button>
                <button id="hardBreakButton">‚Üµ</button>
                <button id="insertTableButton">
                    <i class="fa-solid fa-table"></i>
                </button>
                <label class="color-button">
                    <i class="fa-solid fa-palette"></i>
                    <input type="color" id="colorPicker" style="opacity: 0; position: absolute; left: 0; top: 0; width: 100%; height: 100%; cursor: pointer;" />
                </label>
                <button id="clearColorButton" title="‡∏•‡πâ‡∏≤‡∏á‡∏™‡∏µ" class="color-button">üßπ</button>
                <button id="undoButton">‚ü≤</button>
                <button id="redoButton">‚ü≥</button>
                <button id="paragraphButton">
                    <i class="fa-solid fa-paragraph"></i>
                </button>
            </div>

            <div class="bottom-sheet-overlay" id="bottomSheetOverlay" style="display: none;">
                <div class="bottom-sheet" id="bottomSheet">
                    <div class="bottom-sheet-header">
                        <h2>Background</h2>
                        <button class="bottom-sheet-close-btn" id="closeBottomSheetButton">&times;</button>
                    </div>

                    <div class="option-section color-options">
                        <div class="option-grid" id="colorGrid">
                            <div class="color-option" data-color="#FFFFFF" style="background-color: #ffffff;"></div>
                            <div class="color-option" data-color="#FF5722" style="background-color: #ff5722;"></div>
                            <div class="color-option" data-color="#FF0000" style="background-color: #ff0000;"></div>
                            <div class="color-option" data-color="#FFA500" style="background-color: #ffa500;"></div>
                            <div class="color-option" data-color="#FFFF00" style="background-color: #ffff00;"></div>
                            <div class="color-option" data-color="#00FF00" style="background-color: #00ff00;"></div>
                            <div class="color-option" data-color="#00C853" style="background-color: #00c853;"></div>
                            <div class="color-option" data-color="#4285F4" style="background-color: #4285f4;"></div>
                            <div class="color-option" data-color="#9C27B0" style="background-color: #9c27b0;"></div>
                            <div class="color-option" data-color="#00BCD4" style="background-color: #00bcd4;"></div>
                            <div class="color-option" data-color="#795548" style="background-color: #795548;"></div>
                            <div class="color-option" data-color="#607D8B" style="background-color: #607d8b;"></div>
                            <div class="color-option" data-color="#9E9E9E" style="background-color: #9e9e9e;"></div>
                            <div class="color-option" data-color="#000000" style="background-color: #000000;"></div>
                        </div>
                    </div>

                    <div class="option-section image-options">
                        <div class="option-grid" id="imageGrid">
                            <input type="file" id="fileInput" accept="image/*" />
                            <div class="image-option" id="uploadImageOption">
                                <i class="fa-solid fa-upload"></i>
                            </div>
                            <div class="image-option" data-image-url="images/your_uploaded_image1.jpg">
                                <img src="images/your_uploaded_image1.jpg" alt="Uploaded Image 1" />
                            </div>
                            <div class="image-option" data-image-url="images/your_uploaded_image2.jpg">
                                <img src="images/your_uploaded_image2.jpg" alt="Uploaded Image 2" />
                            </div>
                            <div class="image-option" data-image-url="images/your_uploaded_image3.jpg">
                                <img src="images/your_uploaded_image3.jpg" alt="Uploaded Image 3" />
                            </div>
                            <div class="image-option" data-image-url="https://via.placeholder.com/150/FF0000/FFFFFF?text=Img1">
                                <img src="https://via.placeholder.com/150/FF0000/FFFFFF?text=Img1" alt="Image 1" />
                            </div>
                            <div class="image-option" data-image-url="https://via.placeholder.com/150/00FF00/FFFFFF?text=Img2">
                                <img src="https://via.placeholder.com/150/00FF00/FFFFFF?text=Img2" alt="Image 2" />
                            </div>
                            <div class="image-option" data-image-url="https://via.placeholder.com/150/0000FF/FFFFFF?text=Img3">
                                <img src="https://via.placeholder.com/150/0000FF/FFFFFF?text=Img3" alt="Image 3" />
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="bottom-sheet-overlay" id="settingsBottomSheetOverlay" style="display: none;">
                <div class="bottom-sheet" id="settingsBottomSheet">
                    <div class="chip"><i class="fa-solid fa-pen-to-square"></i>NOTE</div>
                    <div class="bottom-sheet-header">
                        <h1 id="settingsNoteTitle" placeholder="Note Title"></h1>
                        <button class="bottom-sheet-close-btn" id="closeSettingsBottomSheetButton">&times;</button>
                    </div>
                    <div class="option-section title-section"></div>
                    <div class="option-section chip-section">
                        <div class="chip-grid">
                            <button class="setting-button"><i class="fa-solid fa-thumbtack"></i> Pin</button>
                            <div class="option-section title-section"></div>
                            <button class="setting-button" id="backgroundButton"><i class="fa-solid fa-palette"></i> Background</button>
                            <button class="setting-button"><i class="fa-solid fa-tags"></i> Category</button>
                            <button class="setting-button"><i class="fa-solid fa-face-smile"></i> Icon</button>
                            <button class="setting-button"><i class="fa-solid fa-trash-can"></i> Delete</button>
                        </div>
                    </div>
                </div>
            </div>

            <input type="file" id="imageUploader" accept="image/*" style="display: none;" />
            <div id="cropModal" style="display: none; position: fixed; inset: 0; background: rgba(0, 0, 0, 0.6); z-index: 9999; align-items: center; justify-content: center;">
                <div style="background: white; padding: 10px; max-width: 90%; max-height: 90%;">
                    <img id="cropperImage" style="max-width: 100%; max-height: 60vh;" />
                    <div style="text-align: right; margin-top: 10px;">
                        <button id="cropCancelButton">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                        <button id="cropInsertButton">‡πÅ‡∏ó‡∏£‡∏Å‡∏£‡∏π‡∏õ</button>
                    </div>
                </div>
            </div>

            <div id="backgroundCropModal" style="display: none;">
                <div>
                    <img id="backgroundCropperImage" />
                    <div class="buttons">
                        <button id="backgroundCropCancelButton">Cancel</button>
                        <button id="backgroundCropApplyButton">Apply Background</button>
                    </div>
                </div>
            </div>
        </div>

        <script type="module">
            import { Editor } from "https://esm.sh/@tiptap/core";
            import StarterKit from "https://esm.sh/@tiptap/starter-kit";
            import Table from "https://esm.sh/@tiptap/extension-table";
            import TableRow from "https://esm.sh/@tiptap/extension-table-row";
            import TableCell from "https://esm.sh/@tiptap/extension-table-cell";
            import TableHeader from "https://esm.sh/@tiptap/extension-table-header";
            import Image from "https://esm.sh/@tiptap/extension-image";
            import Details from "https://esm.sh/@tiptap/extension-details";
            import DetailsContent from "https://esm.sh/@tiptap/extension-details-content";
            import DetailsSummary from "https://esm.sh/@tiptap/extension-details-summary";
            import HorizontalRule from "https://esm.sh/@tiptap/extension-horizontal-rule";
            import Mention from "https://esm.sh/@tiptap/extension-mention";
            import TaskList from "https://esm.sh/@tiptap/extension-task-list";
            import TaskItem from "https://esm.sh/@tiptap/extension-task-item";
            import Color from "https://esm.sh/@tiptap/extension-color";
            import TextStyle from "https://esm.sh/@tiptap/extension-text-style";
            import HardBreak from "https://esm.sh/@tiptap/extension-hard-break";
            import { keymap } from "https://esm.sh/prosemirror-keymap"; // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ
            import { Extension } from "https://esm.sh/@tiptap/core"; // ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ
            import Paragraph from "https://esm.sh/@tiptap/extension-paragraph";

            const SUPABASE_URL = "https://fkntlawaawawiusmjsez.supabase.co";
            const SUPABASE_ANON_KEY =
                "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZrbnRsYXdhYXdhd2l1c21qc2V6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDk5ODcxMjAsImV4cCI6MjA2NTU2MzEyMH0.G-_fLzcpvPla3dUYNCV7qh0j-JHo1Ahr5fS7fQkHdpw";
            const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

            document.addEventListener("DOMContentLoaded", () => {
                const editorWrapper = document.getElementById("editor-wrapper");
                const fileInput = document.getElementById("fileInput"); // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á
                const uploadImageOption = document.getElementById("uploadImageOption"); // ‡∏õ‡∏∏‡πà‡∏°‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á

                const urlParams = new URLSearchParams(window.location.search);
                let noteId = urlParams.get("noteId"); // ‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô null ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ noteId ‡πÉ‡∏ô URL
                console.log("Note ID from URL:", noteId);
                let currentNoteData = null; // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏ô‡πâ‡∏ï‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÇ‡∏´‡∏•‡∏î‡∏°‡∏≤
                let hasUnsavedChanges = false; // Flag ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á
                let isSaving = false;
                // --- ‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏° ---
                loadNote(noteId);

                let autosaveTimeout; // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏Å‡πá‡∏ö Timer ‡∏Ç‡∏≠‡∏á Autosave

                // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô Debounce
                function debounce(func, delay) {
                    return function (...args) {
                        clearTimeout(autosaveTimeout); // ‡∏•‡πâ‡∏≤‡∏á Timer ‡πÄ‡∏Å‡πà‡∏≤‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏û‡∏¥‡∏°‡∏û‡πå‡πÉ‡∏´‡∏°‡πà
                        console.log("777");
                        autosaveTimeout = setTimeout(() => {
                            func.apply(this, args); // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô saveNote ‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å delay
                        }, delay);
                    };
                }

                // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô saveNote ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å Debounce ‡πÑ‡∏ß‡πâ (‡πÉ‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πâ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÉ‡∏´‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏´‡∏¢‡∏∏‡∏î‡∏û‡∏¥‡∏°‡∏û‡πå 2 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ)
                const debouncedSaveNote = debounce(saveNote, 2000); // 2000 ‡∏°‡∏¥‡∏•‡∏•‡∏¥‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ = 2 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ

                // Settings Bottom Sheet Elements *** NEW ***
                const settingsButton = document.getElementById("settingsButton");
                const settingsBottomSheetOverlay = document.getElementById("settingsBottomSheetOverlay");
                const closeSettingsBottomSheetButton = document.getElementById("closeSettingsBottomSheetButton");
                //const settingsNoteTitleInput = document.getElementById("settingsNoteTitle");
                const settingsNoteTitleElement = document.getElementById("settingsNoteTitle");

                // ‡πÄ‡∏õ‡∏¥‡∏î bottom sheet
                document.getElementById("backgroundButton").addEventListener("click", () => {
                    document.getElementById("bottomSheetOverlay").style.display = "flex";
                });

                // ‡∏õ‡∏¥‡∏î bottom sheet
                document.getElementById("closeBottomSheetButton").addEventListener("click", () => {
                    document.getElementById("bottomSheetOverlay").style.display = "none";
                });

                // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏µ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á
                document.querySelectorAll(".color-option").forEach((option) => {
                    option.addEventListener("click", () => {
                        const color = option.dataset.color;
                        document.getElementById("editor-wrapper").style.backgroundColor = color;
                        document.getElementById("bottomSheetOverlay").style.display = "none";
                        debouncedSaveNote();
                    });
                });

                // Open Settings Bottom Sheet *** UPDATED ***
                settingsButton.addEventListener("click", () => {
                    // Set textContent for the H2 element
                    settingsNoteTitleElement.textContent = document.getElementById("note-title").value; // Populate title
                    settingsBottomSheetOverlay.style.display = "flex";
                    //   setTimeout(() => settingsBottomSheetOverlay.classList.add('show'), 10); // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö transition
                });

                // Close Settings Bottom Sheet *** NEW ***
                closeSettingsBottomSheetButton.addEventListener("click", () => {
                    settingsBottomSheetOverlay.classList.remove("show");
                    settingsBottomSheetOverlay.style.display = "none";
                    //    setTimeout(() => settingsBottomSheetOverlay.style.display = "none", 300); // ‡∏£‡∏≠ transition ‡∏à‡∏ö
                });

                // Close Settings Bottom Sheet when clicking outside (on the overlay) *** NEW ***
                settingsBottomSheetOverlay.addEventListener("click", (event) => {
                    if (event.target === settingsBottomSheetOverlay) {
                        closeSettingsBottomSheetButton.click(); // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ click ‡∏ö‡∏ô‡∏õ‡∏∏‡πà‡∏°‡∏õ‡∏¥‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ logic ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô
                    }
                });

                // === NEW: ‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á ===

                const backgroundFileInput = document.getElementById("backgroundFileInput");
                const backgroundCropModal = document.getElementById("backgroundCropModal");
                const backgroundCropperImage = document.getElementById("backgroundCropperImage");
                const backgroundCropCancelButton = document.getElementById("backgroundCropCancelButton");
                const backgroundCropApplyButton = document.getElementById("backgroundCropApplyButton");
                let backgroundCropper;

                // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÑ‡∏ß‡πâ‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤
                document.querySelectorAll(".image-option").forEach((option) => {
                    option.addEventListener("click", () => {
                        const imageUrl = option.dataset.imageUrl;
                        if (imageUrl === "none") {
                            // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û" ‡πÉ‡∏´‡πâ‡∏•‡∏ö‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏≠‡∏≠‡∏Å
                            editorWrapper.style.backgroundImage = "none";
                            // ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏™‡∏µ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÑ‡∏î‡πâ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà ‡∏´‡∏≤‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏µ‡∏Ç‡∏≤‡∏ß‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û
                            editorWrapper.style.backgroundColor = "#fff";
                        } else {
                            // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á
                            editorWrapper.style.backgroundImage = `url('${imageUrl}')`;
                            // ‡∏•‡πâ‡∏≤‡∏á background-color ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏†‡∏≤‡∏û
                            editorWrapper.style.backgroundColor = "transparent";
                        }
                        bottomSheetOverlay.style.display = "none";
                        debouncedSaveNote();
                    });
                });

                // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏õ‡∏∏‡πà‡∏°‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á (‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô)
                uploadImageOption.addEventListener("click", () => {
                    fileInput.click(); // ‡∏Ñ‡∏•‡∏¥‡∏Å input type="file" ‡∏ó‡∏µ‡πà‡∏ã‡πà‡∏≠‡∏ô‡∏≠‡∏¢‡∏π‡πà
                });

                // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏à‡∏≤‡∏Å input
                fileInput.addEventListener("change", (event) => {
                    const file = event.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            editorWrapper.style.backgroundImage = `url('${e.target.result}')`;
                            editorWrapper.style.backgroundColor = "transparent"; // ‡∏•‡πâ‡∏≤‡∏á background-color ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏†‡∏≤‡∏û
                            bottomSheetOverlay.style.display = "none";
                            fileInput.value = ""; // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏Ñ‡πà‡∏≤ input ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏î‡∏¥‡∏°‡πÑ‡∏î‡πâ‡∏≠‡∏µ‡∏Å
                            debouncedSaveNote();
                        };
                        reader.readAsDataURL(file); // ‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏õ‡πá‡∏ô Data URL
                    }
                });

                // === ‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á ===

                const LargeParagraph = Paragraph.extend({
                    name: "largeParagraph",
                    addOptions() {
                        return {
                            HTMLAttributes: {
                                class: "large-paragraph",
                            },
                        };
                    },
                    addCommands() {
                        return {
                            setLargeParagraph: () => ({ commands, editor }) => {
                                // *** ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ: ‡πÄ‡∏û‡∏¥‡πà‡∏° 'editor' ***
                                // ‡∏•‡∏ö‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î console.log() ‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ Debug ‡∏≠‡∏≠‡∏Å‡πÑ‡∏õ
                                // console.log("commands object in setLargeParagraph:", commands);
                                // console.log("Does commands have isActive?", typeof commands.isActive);

                                // *** ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ: ‡πÉ‡∏ä‡πâ editor.isActive ‡πÅ‡∏ó‡∏ô commands.isActive ***
                                if (editor.isActive(this.name)) {
                                    // 'this.name' ‡∏Ñ‡∏∑‡∏≠ 'largeParagraph'
                                    return commands.setParagraph();
                                }
                                return commands.setNode(this.name);
                            },
                        };
                    },
                });

                const thaiMonths = ["‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°", "‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå", "‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°", "‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô", "‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°", "‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô", "‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°", "‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°", "‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô", "‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°", "‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô", "‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°"];

                const insertTimeButton = document.getElementById("insertTimeButton");
                if (insertTimeButton) {
                    insertTimeButton.addEventListener("click", () => {
                        const now = new Date();
                        const day = now.getDate();
                        const month = thaiMonths[now.getMonth()]; // ‡πÉ‡∏ä‡πâ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÑ‡∏ó‡∏¢
                        const year = now.getFullYear() + 543; // ‡∏õ‡∏µ‡∏û‡∏∏‡∏ó‡∏ò‡∏®‡∏±‡∏Å‡∏£‡∏≤‡∏ä
                        const hours = String(now.getHours()).padStart(2, "0");
                        const minutes = String(now.getMinutes()).padStart(2, "0");

                        const formattedTime = `${day} ${month} ${year} ${hours}:${minutes}`;

                        // ‡πÅ‡∏ó‡∏£‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡∏á‡πÉ‡∏ô Tiptap Editor
                        editor.chain().insertContent(formattedTime).run();
                    });
                }

                const editor = new Editor({
                    element: document.querySelector("#editor"),
                    extensions: [
                        //StarterKit,

                        StarterKit.configure({
                            hardBreak: false,
                            paragraph: false, // ‡∏õ‡∏¥‡∏î paragraph default behavior
                        }),
                        Image,
                        Table.configure({ resizable: true }),
                        TableRow,
                        TableCell,
                        TableHeader,
                        HorizontalRule,
                        Color,
                        TextStyle,
                        Paragraph,
                        LargeParagraph,
                        HardBreak,

                        TaskList,
                        TaskItem.configure({
                            nested: true, // ‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏°‡∏µ‡πÄ‡∏ä‡πá‡∏Å‡∏•‡∏¥‡∏™‡∏ï‡πå‡∏ã‡πâ‡∏≠‡∏ô‡∏Å‡∏±‡∏ô‡πÑ‡∏î‡πâ
                        }),

                        Mention.configure({
                            HTMLAttributes: {
                                class: "mention",
                            },
                            suggestion: {
                                char: "@",
                                startOfLine: false,
                                items: ({ query }) => {
                                    const all = ["Wiroj", "Admin", "Guest", "ChatGPT", "Tiptap"];
                                    return all.filter((name) => name.toLowerCase().startsWith(query.toLowerCase())).slice(0, 5);
                                },
                                render: () => {
                                    let component;
                                    let popup;

                                    return {
                                        onStart: (props) => {
                                            component = document.createElement("div");
                                            component.className = "mention-list";
                                            component.style.position = "absolute";
                                            component.style.background = "#fff";
                                            component.style.border = "1px solid #ccc";
                                            component.style.padding = "4px";
                                            component.style.borderRadius = "6px";
                                            component.style.boxShadow = "0 2px 6px rgba(0,0,0,0.1)";
                                            component.style.zIndex = "9999";

                                            popup = props.clientRect();
                                            if (popup) {
                                                component.style.left = popup.left + "px";
                                                component.style.top = popup.bottom + "px";
                                            }

                                            props.items.forEach((item, index) => {
                                                const option = document.createElement("div");
                                                option.className = "mention-option";
                                                option.style.padding = "4px 8px";
                                                option.style.cursor = "pointer";
                                                option.textContent = item;
                                                option.onclick = () => props.command({ id: item, label: item });
                                                component.appendChild(option);
                                            });

                                            document.body.appendChild(component);
                                        },
                                        onUpdate: (props) => {
                                            while (component.firstChild) component.removeChild(component.firstChild);
                                            props.items.forEach((item, index) => {
                                                const option = document.createElement("div");
                                                option.className = "mention-option";
                                                option.style.padding = "4px 8px";
                                                option.style.cursor = "pointer";
                                                option.textContent = item;
                                                option.onclick = () => props.command({ id: item, label: item });
                                                component.appendChild(option);
                                            });
                                        },
                                        onKeyDown(props) {
                                            return false;
                                        },
                                        onExit: () => {
                                            if (component) {
                                                component.remove();
                                                component = null;
                                            }
                                        },
                                    };
                                },
                            },
                        }),

                        Details.configure({
                            persist: true,
                            HTMLAttributes: {
                                class: "details",
                            },
                        }),
                        DetailsSummary,
                        DetailsContent,
                    ],
                    content: '<p data-placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà..."></p>',
                    autofocus: true,

                    onUpdate({ editor }) {
                        updateToolbar(editor); // ‡∏≠‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß
                        debouncedSaveNote(); // <--- ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÇ‡∏Ñ‡πâ‡∏î‡∏ô‡∏µ‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ
                    },

                    onSelectionUpdate: ({ editor }) => updateToolbar(editor),
                });

                // --- ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ: ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô loadNote ---
                const noteTitleInput = document.getElementById("note-title"); // ‡πÑ‡∏î‡πâ‡∏Ñ‡πà‡∏≤ input ‡∏Ç‡∏≠‡∏á title
                noteTitleInput.addEventListener("input", () => {
                    // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏û‡∏¥‡∏°‡∏û‡πå‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏ô‡πâ‡∏ï
                    debouncedSaveNote(); // <<< ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ
                    navbarTitle.textContent = noteTitleInput.value.trim() || "New Note"; // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏ô Navbar ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
                });

                const navbarTitle = document.querySelector(".navbar-title"); // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏ô‡πâ‡∏ï‡πÉ‡∏ô Navbar

                async function loadNote(id) {
                    if (!id) {
                        // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ ID ‡∏Ñ‡∏∑‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏ô‡πâ‡∏ï‡πÉ‡∏´‡∏°‡πà
                        noteTitleInput.value = "";
                        editor.commands.setContent('<p data-placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà..."></p>');
                        navbarTitle.textContent = "New Note"; // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏ô Navbar
                        currentNoteData = null; // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏ô‡πâ‡∏ï
                        console.log("Creating new note.");
                        return;
                    }

                    // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ ID ‡πÉ‡∏´‡πâ‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏ô‡πâ‡∏ï‡πÄ‡∏î‡∏¥‡∏°
                    console.log("Loading note with ID:", id);
                    const { data, error } = await supabase
                        .from("NOTE")
                        .select("*") // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Ç‡∏≠‡∏á‡πÇ‡∏ô‡πâ‡∏ï
                        .eq("id", id)
                        .single(); // ‡∏Ñ‡∏≤‡∏î‡∏´‡∏ß‡∏±‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡πÄ‡∏î‡∏µ‡∏¢‡∏ß

                    if (error) {
                        console.error("Error loading note:", error.message);
                        alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏ô‡πâ‡∏ï");
                        return;
                    }

                    if (data) {
                        currentNoteData = data;
                        noteTitleInput.value = data.title || "";
                        // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤ Tiptap
                        if (data.content && typeof data.content === "object") {
                            editor.commands.setContent(data.content);
                        } else if (typeof data.content === "string") {
                            // ‡∏Å‡∏£‡∏ì‡∏µ content ‡∏ñ‡∏π‡∏Å‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏õ‡πá‡∏ô HTML string (‡πÑ‡∏°‡πà‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏ñ‡πâ‡∏≤‡πÉ‡∏ä‡πâ Tiptap JSONB)
                            editor.commands.setContent(data.content);
                        } else {
                            editor.commands.setContent('<p data-placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà..."></p>');
                        }

                        // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á Editor Wrapper ‡∏ï‡∏≤‡∏°‡∏Ñ‡πà‡∏≤ background ‡πÉ‡∏ô Note
                        if (data.background) {
                            try {
                                const backgroundData = data.background;
                                if (backgroundData.type === "color" && backgroundData.value) {
                                    editorWrapper.style.backgroundColor = backgroundData.value;
                                    editorWrapper.style.backgroundImage = "none";
                                } else if (backgroundData.type === "image" && backgroundData.value) {
                                    editorWrapper.style.backgroundImage = `url('${backgroundData.value}')`;
                                    editorWrapper.style.backgroundSize = "cover";
                                    editorWrapper.style.backgroundPosition = "center";
                                    editorWrapper.style.backgroundRepeat = "no-repeat";
                                    editorWrapper.style.backgroundColor = "transparent";
                                }
                            } catch (e) {
                                console.error("Failed to apply background from note:", e);
                            }
                        } else {
                            editorWrapper.style.backgroundColor = "#f8f8f8"; // Default fallback
                            editorWrapper.style.backgroundImage = "none";
                        }
                        navbarTitle.textContent = data.title || "Untitled Note"; // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏ô Navbar
                        hasUnsavedChanges = false; // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à ‡∏ñ‡∏∑‡∏≠‡∏ß‡πà‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á
                    } else {
                        // ‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÇ‡∏ô‡πâ‡∏ï ‡πÉ‡∏´‡πâ‡∏ñ‡∏∑‡∏≠‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏ô‡πâ‡∏ï‡πÉ‡∏´‡∏°‡πà
                        console.log("Note not found, starting a new note.");
                        await loadNote(null); // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡πÇ‡∏´‡∏°‡∏î‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà
                    }
                }
                // --- ‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏° loadNote ---

                // --- ‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ‡∏Ñ‡∏∑‡∏≠‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô saveNote() ‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡πÅ‡∏•‡πâ‡∏ß ---
                async function saveNote() {
                    if (isSaving) {
                        console.log("Save in progress, skipping this call.");
                        return; // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß ‡πÉ‡∏´‡πâ‡∏Ç‡πâ‡∏≤‡∏°‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ô‡∏µ‡πâ‡πÑ‡∏õ
                    }

                    isSaving = true; // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ß‡πà‡∏≤‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å

                    try {
                        console.log("Attempting to save note...");
                        const title = noteTitleInput.value.trim();
                        const content = editor.getJSON(); // ‡∏´‡∏£‡∏∑‡∏≠ editor.getHTML()
                        const editorWrapperElement = document.getElementById("editor-wrapper");
                        let backgroundData = null;

                        // --- ‡πÄ‡∏û‡∏¥‡πà‡∏° console.log ‡πÄ‡∏´‡∏•‡πà‡∏≤‡∏ô‡∏µ‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤ ---
                        console.log("DEBUG saveNote: editorWrapperElement.style.backgroundImage =", editorWrapperElement.style.backgroundImage);
                        console.log("DEBUG saveNote: editorWrapperElement.style.backgroundColor =", editorWrapperElement.style.backgroundColor);
                        // --- ‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏° console.log ---

                        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Background Image ‡∏Å‡πà‡∏≠‡∏ô
                        const backgroundImage = editorWrapperElement.style.backgroundImage;
                        if (backgroundImage && backgroundImage !== "none") {
                            const imageUrlMatch = backgroundImage.match(/url\(['"]?(.*?)['"]?\)/);
                            if (imageUrlMatch && imageUrlMatch[1]) {
                                backgroundData = { type: "image", value: imageUrlMatch[1] };
                            }
                        } else {
                            // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ Background Image ‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Background Color
                            const backgroundColor = editorWrapperElement.style.backgroundColor;
                            if (backgroundColor && backgroundColor !== "transparent" && backgroundColor !== "rgba(0, 0, 0, 0)") {
                                backgroundData = { type: "color", value: backgroundColor };
                            }
                        }

                        // --- ‡πÄ‡∏û‡∏¥‡πà‡∏° console.log ‡∏ô‡∏µ‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤ ---
                        console.log("DEBUG saveNote: backgroundData to be saved =", backgroundData);
                        // --- ‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏° console.log ---

                        const noteToSave = {
                            title: title || "Untitled Note",
                            content: content,
                            updated_at: new Date().toISOString(),
                            background: backgroundData,
                        };

                        if (noteId) {
                            // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÇ‡∏ô‡πâ‡∏ï‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà
                            const { data, error } = await supabase.from("NOTE").update(noteToSave).eq("id", noteId).select();

                            if (error) {
                                console.error("Error updating note:", error.message);
                            } else {
                                console.log("Note updated successfully:", data);
                                currentNoteData = data[0];
                                navbarTitle.textContent = title;
                                hasUnsavedChanges = false;
                            }
                        } else {
                            // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏ô‡πâ‡∏ï‡πÉ‡∏´‡∏°‡πà
                            const { data, error } = await supabase.from("NOTE").insert([noteToSave]).select();

                            if (error) {
                                console.error("Error inserting new note:", error.message);
                            } else {
                                console.log("New note created successfully:", data);
                                if (data && data.length > 0) {
                                    currentNoteData = data[0];
                                    noteId = data[0].id; // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î noteId ‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏à‡∏≤‡∏Å DB

                                    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï URL ‡πÉ‡∏ô Browser ‡πÉ‡∏´‡πâ‡∏°‡∏µ noteId ‡πÉ‡∏´‡∏°‡πà
                                    const newUrl = new URL(window.location.href);
                                    newUrl.searchParams.set("noteId", noteId);
                                    window.history.replaceState({}, "", newUrl);

                                    navbarTitle.textContent = title;
                                    hasUnsavedChanges = false;
                                }
                            }
                        }
                    } finally {
                        isSaving = false; // <<< ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏°‡∏≤‡∏Å: ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ß‡πà‡∏≤‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß (‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏à‡∏∞‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡∏´‡∏£‡∏∑‡∏≠‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß)
                    }
                }
                // --- ‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô saveNote() ---

                document.getElementById("colorPicker").addEventListener("input", (event) => {
                    const color = event.target.value;
                    editor.chain().focus().setColor(color).run();
                });

                document.getElementById("clearColorButton").addEventListener("click", () => {
                    editor.chain().focus().unsetColor().run();
                });

                document.getElementById("toggleLargeParagraphButton").addEventListener("click", () => {
                    editor.chain().focus().setLargeParagraph().run();
                });
                
                const buttons = {
                    taskListButton: () => editor.chain().focus().toggleTaskList().run(),
                    detailsButton: () => editor.chain().focus().setDetails().run(),
                    hrButton: () => editor.chain().focus().setHorizontalRule().run(),
                    imageButton: () => document.getElementById("imageUploader").click(),
                    boldButton: () => editor.chain().focus().toggleBold().run(),
                    italicButton: () => editor.chain().focus().toggleItalic().run(),
                    strikeButton: () => editor.chain().focus().toggleStrike().run(),
                    codeTextButton: () => editor.chain().focus().toggleCode().run(),
                    paragraphButton: () => editor.chain().focus().setParagraph().run(),
                    h1Button: () => editor.chain().focus().toggleHeading({ level: 1 }).run(),
                    h2Button: () => editor.chain().focus().toggleHeading({ level: 2 }).run(),
                    bulletListButton: () => editor.chain().focus().toggleBulletList().run(),
                    orderedListButton: () => editor.chain().focus().toggleOrderedList().run(),
                    codeBlockButton: () => editor.chain().focus().toggleCodeBlock().run(),
                    blockquoteButton: () => editor.chain().focus().toggleBlockquote().run(),
                    hrButton: () => editor.chain().focus().setHorizontalRule().run(),
                    hardBreakButton: () => editor.chain().focus().setHardBreak().run(),
                    insertTableButton: () => editor.chain().focus().insertTable({ rows: 3, cols: 3, withHeaderRow: true }).run(),
                    undoButton: () => editor.chain().focus().undo().run(),
                    redoButton: () => editor.chain().focus().redo().run(),
                };

                Object.keys(buttons).forEach((id) => {
                    const btn = document.getElementById(id);
                    if (btn) btn.addEventListener("click", buttons[id]);
                });

                let cropper;
                const imageUploader = document.getElementById("imageUploader");
                const cropModal = document.getElementById("cropModal");
                const cropperImage = document.getElementById("cropperImage");

                imageUploader.addEventListener("change", (event) => {
                	console.log("888");
                    const file = event.target.files[0];
                    if (!file) return;

                    const reader = new FileReader();
                    reader.onload = () => {
                        cropperImage.src = reader.result;
                        cropModal.style.display = "flex";

                        // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô cropper ‡∏ã‡πâ‡∏≠‡∏ô
                        if (cropper) cropper.destroy();

                        cropper = new Cropper(cropperImage, {
                            aspectRatio: NaN, // ‡∏´‡∏£‡∏∑‡∏≠‡πÉ‡∏™‡πà 1, 16/9 ‡∏ï‡∏≤‡∏°‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£
                            viewMode: 1,
                            autoCropArea: 1,
                        });
                    };
                    reader.readAsDataURL(file);
                });

                // ‡πÅ‡∏ó‡∏£‡∏Å‡∏£‡∏π‡∏õ
                document.getElementById("cropInsertButton").addEventListener("click", () => {
                    if (!cropper) return;
                    const canvas = cropper.getCroppedCanvas();
                    const base64 = canvas.toDataURL();

                    editor.chain().focus().setImage({ src: base64 }).run();

                    cropper.destroy();
                    cropModal.style.display = "none";
                });

                document.getElementById("cropCancelButton").addEventListener("click", () => {
                    if (cropper) cropper.destroy();
                    cropModal.style.display = "none";
                });

                function updateToolbar(editor) {
                    const states = {
                        taskListButton: editor.isActive("taskList"),
                        boldButton: editor.isActive("bold"),
                        italicButton: editor.isActive("italic"),
                        strikeButton: editor.isActive("strike"),
                        codeTextButton: editor.isActive("code"),
                        paragraphButton: editor.isActive("paragraph"),
                        h1Button: editor.isActive("heading", { level: 1 }),
                        h2Button: editor.isActive("heading", { level: 2 }),
                        bulletListButton: editor.isActive("bulletList"),
                        orderedListButton: editor.isActive("orderedList"),
                        codeBlockButton: editor.isActive("codeBlock"),
                        blockquoteButton: editor.isActive("blockquote"),
                        toggleLargeParagraphButton: editor.isActive("largeParagraph"),
                    };
                    for (const id in states) {
                        const btn = document.getElementById(id);
                        if (btn) btn.classList.toggle("is-active", states[id]);
                    }
                }
                window.getNoteData = () => ({
                    title: document.getElementById("note-title").value,
                    content: editor.getHTML(),
                });
                window.editor = editor;
            });
        </script>
    </body>
</html>